import { Button } from "@/components/ui/button";
import { Search, ShoppingCart } from "lucide-react";
import UserDropDownMenu from "../shared/user-drop-down-menu";
import { useLocation, useNavigate } from "react-router-dom";
import { routes } from "@/config";
import {
  forwardRef,
  KeyboardEvent,
  useImperativeHandle,
  useState,
} from "react";

export interface ProductLayoutRef {
  getSearchText: () => string;
  setSearchText: (value: string) => void;
}

export interface ProductLayoutProps {
  children: React.ReactNode;
}

const ProductLayout = forwardRef<ProductLayoutRef, ProductLayoutProps>(
  function ProductLayout({ children }, ref) {
    const [searchText, setSearchText] = useState<string>("");
    const navigate = useNavigate();
    const location = useLocation();

    useImperativeHandle(ref, () => {
      return {
        getSearchText() {
          return searchText;
        },
        setSearchText(value: string) {
          setSearchText(value);
        },
      };
    });

    const handleSearch = () => {
      if (location.pathname !== routes.CUSTOMER.HOME) {
        if (searchText.trim() !== "")
          navigate(`${routes.CUSTOMER.HOME}?title=${searchText.trim()}`);
        else {
          navigate(`${routes.CUSTOMER.HOME}`);
        }
      } else {
        const searchParams = new URLSearchParams(location.search);
        const param = Object.fromEntries(searchParams.entries());
        const newParams = { ...param, title: searchText.trim() };
        const newSearchParams = new URLSearchParams();
        Object.entries(newParams).forEach(([key, value]) => {
          if (value !== undefined && value !== null && value !== "") {
            newSearchParams.set(key, String(value));
          }
        });

        const paramString = newSearchParams.toString();
        const url = paramString
          ? `${location.pathname}?${paramString}`
          : location.pathname;

        navigate(url);
      }
    };

    const handleEnterPress = (event: KeyboardEvent<HTMLInputElement>) => {
      if (event.key === "Enter") {
        handleSearch();
      }
    };

    return (
      <div className="h-screen w-full grid grid-rows-[96px_1fr]">
        <div className="px-40 h-full w-full flex flex-row items-center bg-[#fff] gap-16">
          <a href="/" className="text-white text-nowrap  text-2xl font-bold">
            <svg
              width="239"
              height="60"
              viewBox="0 0 239 60"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M18.1325 10.6375C19.1949 8.38847 20.8745 6.48767 22.9755 5.15648C25.0766 3.82529 27.5127 3.11853 30 3.11853C32.4873 3.11853 34.9234 3.82529 37.0244 5.15648C39.1255 6.48767 40.8051 8.38847 41.8675 10.6375C45.1144 10.4935 48.3142 11.4541 50.945 13.3626C53.5757 15.271 55.4822 18.0146 56.3532 21.1457C57.2242 24.2769 57.0085 27.6109 55.7412 30.6037C54.4739 33.5965 52.2298 36.0715 49.375 37.625V45.13C49.375 47.3775 49.375 49.25 49.175 50.735C48.965 52.305 48.5 53.7225 47.36 54.86C46.2225 56 44.805 56.465 43.235 56.675C41.75 56.875 39.875 56.875 37.63 56.875H22.37C20.125 56.875 18.25 56.875 16.765 56.675C15.195 56.465 13.7775 56 12.64 54.86C11.5 53.7225 11.035 52.305 10.825 50.735C10.625 49.25 10.625 47.3775 10.625 45.13V37.6275C7.77022 36.074 5.52612 33.599 4.25881 30.6062C2.99149 27.6134 2.77576 24.2794 3.6468 21.1482C4.51784 18.0171 6.42425 15.2735 9.05501 13.3651C11.6858 11.4566 14.8856 10.4935 18.1325 10.6375ZM17.0075 14.39C14.611 14.5007 12.3225 15.4193 10.5144 16.9962C8.70634 18.573 7.48517 20.7154 7.04961 23.0746C6.61405 25.4338 6.98974 27.871 8.11555 29.9896C9.24135 32.1081 11.051 33.7833 13.25 34.7425C13.5842 34.8883 13.8687 35.1285 14.0685 35.4335C14.2683 35.7386 14.3748 36.0953 14.375 36.46V43.125H45.625V36.46C45.6252 36.0953 45.7317 35.7386 45.9315 35.4335C46.1313 35.1285 46.4158 34.8883 46.75 34.7425C48.9482 33.7824 50.757 32.1068 51.8821 29.9883C53.0073 27.8699 53.3827 25.433 52.9472 23.0741C52.5118 20.7153 51.2911 18.5731 49.4838 16.9959C47.6764 15.4188 45.3886 14.4995 42.9925 14.3875C43.0808 14.9958 43.125 15.6166 43.125 16.25V17.5C43.125 17.9972 42.9275 18.4742 42.5758 18.8258C42.2242 19.1774 41.7473 19.375 41.25 19.375C40.7527 19.375 40.2758 19.1774 39.9242 18.8258C39.5725 18.4742 39.375 17.9972 39.375 17.5V16.25C39.3763 15.0184 39.1347 13.7988 38.664 12.6607C38.1934 11.5227 37.5029 10.4887 36.6321 9.6179C35.7612 8.74708 34.7272 8.05658 33.5892 7.58591C32.4512 7.11523 31.2315 6.87364 30 6.87496C27.5136 6.87496 25.129 7.86268 23.3709 9.62083C21.6127 11.379 20.625 13.7636 20.625 16.25V17.5C20.625 17.9972 20.4275 18.4742 20.0758 18.8258C19.7242 19.1774 19.2473 19.375 18.75 19.375C18.2527 19.375 17.7758 19.1774 17.4242 18.8258C17.0725 18.4742 16.875 17.9972 16.875 17.5V16.25C16.875 15.6166 16.9192 14.9983 17.0075 14.39ZM45.62 46.875H14.38C14.39 48.3 14.425 49.375 14.5425 50.2375C14.6975 51.39 14.965 51.885 15.2925 52.21C15.62 52.535 16.11 52.8025 17.2625 52.96C18.47 53.12 20.09 53.125 22.5 53.125H37.5C39.91 53.125 41.53 53.12 42.7375 52.9575C43.89 52.8025 44.385 52.535 44.71 52.2075C45.035 51.88 45.3025 51.39 45.46 50.2375C45.575 49.3725 45.61 48.2975 45.62 46.875Z"
                fill="#A93F15"
              />
              <path d="M208.882 52L212 50H183L208.882 52Z" fill="#A93F15" />
              <path d="M135.882 52L139 50H110L135.882 52Z" fill="#A93F15" />
              <path d="M174.882 52L178 50H149L174.882 52Z" fill="#A93F15" />
              <path d="M213.882 21L217 19H188L213.882 21Z" fill="#A93F15" />
              <path d="M179.882 21L183 19H154L179.882 21Z" fill="#A93F15" />
              <path d="M139.882 21L143 19H114L139.882 21Z" fill="#A93F15" />
              <path d="M104.882 32L108 30H79L104.882 32Z" fill="#A93F15" />
              <path d="M102.774 19L106 17H76L102.774 19Z" fill="#A93F15" />
              <path d="M97.8817 46L101 44H72L97.8817 46Z" fill="#A93F15" />
              <path d="M93.5 51.5L98.5 49H52L93.5 51.5Z" fill="#A93F15" />
              <path d="M102.5 13L107.5 10.5H61L102.5 13Z" fill="#A93F15" />
              <path
                d="M126.52 9.88L125.08 17.98H107.92L106.36 27.04H119.2L117.76 34.84H104.92L101.92 52H91.66L99.1 9.88H126.52ZM137.672 52.48C134.792 52.48 132.233 51.9 129.993 50.74C127.752 49.58 126.012 47.94 124.772 45.82C123.572 43.7 122.972 41.24 122.972 38.44C122.972 34.64 123.872 31.18 125.672 28.06C127.472 24.94 129.953 22.5 133.113 20.74C136.273 18.94 139.793 18.04 143.673 18.04C146.553 18.04 149.113 18.64 151.353 19.84C153.632 21 155.392 22.64 156.633 24.76C157.873 26.88 158.493 29.34 158.493 32.14C158.493 35.98 157.573 39.46 155.733 42.58C153.933 45.66 151.433 48.08 148.233 49.84C145.073 51.6 141.552 52.48 137.672 52.48ZM139.113 43.66C140.793 43.66 142.293 43.16 143.613 42.16C144.973 41.12 146.013 39.8 146.733 38.2C147.493 36.56 147.873 34.86 147.873 33.1C147.873 31.1 147.333 29.56 146.253 28.48C145.173 27.4 143.813 26.86 142.173 26.86C140.453 26.86 138.933 27.38 137.613 28.42C136.333 29.42 135.333 30.74 134.612 32.38C133.893 34.02 133.533 35.74 133.533 37.54C133.533 39.5 134.053 41.02 135.092 42.1C136.133 43.14 137.473 43.66 139.113 43.66ZM173.776 52.48C170.896 52.48 168.336 51.9 166.096 50.74C163.856 49.58 162.116 47.94 160.876 45.82C159.676 43.7 159.076 41.24 159.076 38.44C159.076 34.64 159.976 31.18 161.776 28.06C163.576 24.94 166.056 22.5 169.216 20.74C172.376 18.94 175.896 18.04 179.776 18.04C182.656 18.04 185.216 18.64 187.456 19.84C189.736 21 191.496 22.64 192.736 24.76C193.976 26.88 194.596 29.34 194.596 32.14C194.596 35.98 193.676 39.46 191.836 42.58C190.036 45.66 187.536 48.08 184.336 49.84C181.176 51.6 177.656 52.48 173.776 52.48ZM175.216 43.66C176.896 43.66 178.396 43.16 179.716 42.16C181.076 41.12 182.116 39.8 182.836 38.2C183.596 36.56 183.976 34.86 183.976 33.1C183.976 31.1 183.436 29.56 182.356 28.48C181.276 27.4 179.916 26.86 178.276 26.86C176.556 26.86 175.036 27.38 173.716 28.42C172.436 29.42 171.436 30.74 170.716 32.38C169.996 34.02 169.636 35.74 169.636 37.54C169.636 39.5 170.156 41.02 171.196 42.1C172.236 43.14 173.576 43.66 175.216 43.66ZM195.539 35.2C196.139 31.76 197.319 28.74 199.079 26.14C200.839 23.54 202.959 21.54 205.439 20.14C207.919 18.74 210.539 18.04 213.299 18.04C215.499 18.04 217.419 18.5 219.059 19.42C220.739 20.34 221.959 21.58 222.719 23.14L225.479 7.6H235.739L227.879 52H217.619L218.459 47.2C217.179 48.8 215.579 50.08 213.659 51.04C211.739 52 209.599 52.48 207.239 52.48C204.879 52.48 202.779 51.94 200.939 50.86C199.139 49.78 197.719 48.24 196.679 46.24C195.679 44.24 195.179 41.9 195.179 39.22C195.179 37.98 195.299 36.64 195.539 35.2ZM220.619 35.26C220.739 34.54 220.799 33.88 220.799 33.28C220.799 31.32 220.219 29.78 219.059 28.66C217.939 27.54 216.499 26.98 214.739 26.98C212.699 26.98 210.839 27.72 209.159 29.2C207.479 30.64 206.419 32.64 205.979 35.2C205.859 35.92 205.799 36.58 205.799 37.18C205.799 39.14 206.359 40.7 207.479 41.86C208.639 42.98 210.079 43.54 211.799 43.54C213.839 43.54 215.699 42.8 217.379 41.32C219.059 39.84 220.139 37.82 220.619 35.26Z"
                fill="#A93F15"
              />
              <path d="M225 10.5L230 8H178L225 10.5Z" fill="#A93F15" />
            </svg>
          </a>

          <div className="flex w-full rounded-sm items-center space-x-2 bg-white p-[2px]">
            <input
              className="w-full px-2 py-2 rounded-sm border border-[#A93F15]"
              type="search"
              placeholder="Tìm sản phẩm..."
              value={searchText}
              onChange={(e) => setSearchText(e.target.value)}
              onKeyDown={handleEnterPress}
            />
            <Button
              className="rounded-sm bg-[#A93F15] hover:bg-[#FF7E00]"
              onClick={handleSearch}
            >
              <Search className="w-6 h-6 text-white" />
            </Button>
          </div>
          <div className="flex flex-row gap-4 w-fit items-center">
            <div
              className="w-11"
              onClick={() => navigate(routes.CUSTOMER.CART)}
            >
              <ShoppingCart className="h-7 w-7 text-white" />
            </div>
            <div className="w-11">
              <UserDropDownMenu />
            </div>
          </div>
        </div>
        <div className="px-[10%] flex flex-col gap-6 bg-[#f9f9f9] overflow-y-auto">
          {children}
        </div>
      </div>
    );
  }
);

export default ProductLayout;
